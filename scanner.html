<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Scanner</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background: #f4f7fa; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px; }
        
        .scanner-container {
            width: 100%; max-width: 500px;
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }

        #reader { width: 100%; border-radius: 8px; overflow: hidden; }

        /* Result Card (Hidden by default) */
        #result-card {
            display: none; 
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }

        .user-photo {
            width: 150px; height: 150px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid #2563eb;
            margin-bottom: 15px;
        }

        .btn {
            background: #2563eb; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; cursor: pointer;
            margin-top: 15px; font-weight: bold;
        }
        .error { color: #dc2626; font-weight: bold; }
    </style>
</head>
<body>

    <div class="scanner-container">
        <h2><i class="fa-solid fa-qrcode"></i> Scan Tourist ID</h2>
        
        <div id="reader"></div>

        <div id="result-card">
            <h3 id="status-text">Fetching Data...</h3>
            
            <img id="user-doc-image" class="user-photo" src="" alt="User Document">
            
            <h2 id="user-name"></h2>
            <p id="user-info"></p>
            
            <button class="btn" onclick="location.reload()">Scan Next Person</button>
        </div>
    </div>

<script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBzgUTcdlt3DOQvnNsv4f_05sxJt0DUsYg",
        authDomain: "tour-track-ddb18.firebaseapp.com",
        projectId: "tour-track-ddb18",
        storageBucket: "tour-track-ddb18.firebasestorage.app",
        messagingSenderId: "426865781508",
        appId: "1:426865781508:web:8fb7a409f00c536955be51",
        measurementId: "G-TQZT1H6PPS"
    };

    const SUPABASE_URL = 'https://dycovrqatiyfniqssisb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5Y292cnFhdGl5Zm5pcXNzaXNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxOTM0OTksImV4cCI6MjA4Mjc2OTQ5OX0.cAx_nxGS4jRZB5tH7Sro8FCjb8nhv6RIbLXdRS-g9Gc';
    
    // FIX 1: Use window.supabase because of the CDN import
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- SCANNER LOGIC ---
    const scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });

    // FIX 2: Correctly scoped function
    async function onScanSuccess(decodedText) {
        console.log(`Scanned ID: ${decodedText}`);
        
        // Stop the camera
        scanner.clear();

        // Show UI
        document.getElementById('result-card').style.display = 'block';
        document.getElementById('status-text').innerText = "Fetching Data...";

        // 1. Fetch Documents from Supabase
        await fetchSupabaseDocs(decodedText);
        
        // 2. Fetch User Data from Firestore
        await fetchUserData(decodedText);
    }

    async function fetchSupabaseDocs(userId) {
        const resultContainer = document.getElementById('result-card');
        const { data, error } = await supabase.storage.from('secure-docs').list(userId);

        if (error) {
            console.error("Supabase Error:", error);
            return;
        }

        // Remove old images/links if any
        const existingDocs = document.querySelectorAll('.doc-item');
        existingDocs.forEach(el => el.remove());

        data.forEach(file => {
            const { data: urlData } = supabase.storage.from('secure-docs').getPublicUrl(`${userId}/${file.name}`);
            const fileUrl = urlData.publicUrl;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'doc-item';
            
            // Check if it's an image
            if (/\.(jpg|jpeg|png|webp|gif)$/i.test(file.name)) {
                const img = document.createElement('img');
                img.src = fileUrl;
                img.classList.add('user-photo'); // Reusing your existing style
                wrapper.appendChild(img);
            } else {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.innerText = `ðŸ“„ View ${file.name}`;
                link.target = "_blank";
                link.className = 'btn'; 
                link.style.display = 'block';
                wrapper.appendChild(link);
            }
            resultContainer.appendChild(wrapper);
        });
    }

    async function fetchUserData(userId) {
        try {
            const docRef = doc(db, "users", userId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('status-text').style.display = 'none';
                document.getElementById('user-name').innerText = data.fullName || "Unknown Name";
                document.getElementById('user-info').innerText = `Nationality: ${data.nationality || 'N/A'} | Status: ${data.status || 'Active'}`;
            } else {
                document.getElementById('status-text').innerHTML = `<span class="error">User ID Not Found in Database!</span>`;
            }
        } catch (error) {
            console.error("Firestore Error:", error);
        }
    }

    scanner.render(onScanSuccess);
</script>
</body>
</html>
