<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zone Management - Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <link href="https://js.radar.com/v4/radar.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css" />

    <style>
        :root { --bg-color: #f4f7fa; --sidebar-bg: #1f2937; --sidebar-text: #d1d5db; --header-bg: #ffffff; --accent-color: #2563eb; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); display: flex; height: 100vh; overflow: hidden; }
        .page-wrapper { display: flex; width: 100%; }
        .sidebar { width: 250px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; }
        .sidebar-header { padding: 1.5rem; text-align: center; border-bottom: 1px solid #374151; }
        .sidebar-header h2 { color: #fff; font-size: 1.5rem; }
        .sidebar-nav { list-style: none; margin-top: 1rem; }
        .sidebar-nav a { display: flex; align-items: center; padding: 1rem 1.5rem; color: inherit; text-decoration: none; }
        .sidebar-nav a:hover, .sidebar-nav a.active { background: #374151; color: #fff; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; position: relative; }
        .header { background: var(--header-bg); padding: 1rem 2rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .zone-container { display: flex; flex-grow: 1; height: 100%; }
        .map-panel { flex-grow: 1; position: relative; }
        .map-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .management-panel { width: 400px; background: #fff; border-left: 1px solid #e5e7eb; display: flex; flex-direction: column; z-index: 10; }
        .panel-header { padding: 1.5rem; border-bottom: 1px solid #e5e7eb; }
        .zone-list { flex-grow: 1; overflow-y: auto; list-style: none; }
        .zone-item { padding: 1rem 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; }
        .btn-primary { background: var(--accent-color); color: #fff; width: 100%; margin-top: 1rem; }
        .btn-secondary { background: #e5e7eb; color: #000; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 9999; }
        .modal-panel { background: #fff; width: 90%; max-width: 500px; border-radius: 12px; padding: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .modal-footer { text-align: right; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <nav class="sidebar">
            <div class="sidebar-header"><h2>Safety Hub</h2></div>
            <ul class="sidebar-nav">
                <li><a href="homepage.html"><i class="fa-solid fa-table-columns"></i> Dashboard</a></li>
                <li><a href="ZoneManagement.html" class="active"><i class="fa-solid fa-map-marked-alt"></i> Zone Management</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <header class="header">
                <h1>Zone Management</h1>
                <span>Admin</span>
            </header>
            
            <div class="zone-container">
                <div class="map-panel"><div id="map-overlay" class="map-overlay"></div></div>
                <aside class="management-panel">
                    <div class="panel-header">
                        <h2>Manage Zones</h2>
                        <button class="btn btn-primary" onclick="openModal()">+ New Zone</button>
                    </div>
                    <ul class="zone-list"></ul>
                </aside>
            </div>
        </main>
    </div>

    <div id="zone-modal" class="modal-overlay">
        <div class="modal-panel">
            <h2>Create Zone</h2>
            <div class="form-group">
                <label>Zone Name</label>
                <input type="text" id="zone-name" placeholder="e.g. Danger Zone">
            </div>
            <div class="form-group">
                <label>Risk Level</label>
                <select id="zone-risk">
                    <option value="high">High Risk</option>
                    <option value="prohibited">Prohibited</option>
                </select>
            </div>
            <p style="font-size: 0.9em; color: #666;">Click "Save" then draw a polygon on the map.</p>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="width: auto;" onclick="startDrawing()">Save & Draw</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script>window.mapboxgl = maplibregl;</script>
    <script src="https://js.radar.com/v4/radar.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>

    <script>
        // CONFIGURATION
        const RADAR_PK = 'prj_test_pk_9ecb50024e28cc6720ebc1af765b10b4d7a4bf61';
        const RADAR_SK = 'prj_test_sk_58c48260ded3c530a5edbd545b54eba05bd771af';

        // 1. Initialize
        Radar.initialize(RADAR_PK);
        const map = Radar.ui.map({
            container: 'map-overlay',
            style: 'radar-default-v1',
            center: [72.978088, 19.218331],
            zoom: 13
        });
        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: { polygon: true, trash: true }
        });
        map.addControl(draw);

        // UI Helpers
        const modal = document.getElementById('zone-modal');
        const zoneList = document.querySelector('.zone-list');
        function openModal() { modal.style.display = 'flex'; }
        function closeModal() { modal.style.display = 'none'; }

        // 2. Start Drawing
        function startDrawing() {
            const name = document.getElementById('zone-name').value;
            if(!name) return alert("Enter a name");
            closeModal();
            draw.changeMode('draw_polygon');
            
            map.once('draw.create', async (e) => {
                const feature = e.features[0];
                let ring = feature.geometry.coordinates[0];

                // 3. SANITIZE DATA (The "Magic" Fix)
                const cleanRing = [];
                
                // A. Filter out duplicates (Double-click errors)
                for (let i = 0; i < ring.length; i++) {
                    const current = ring[i];
                    if (cleanRing.length === 0) {
                        cleanRing.push(current);
                        continue;
                    }
                    const last = cleanRing[cleanRing.length - 1];
                    // If current point is same as last point, skip it (Overlap fix)
                    if (current[0] === last[0] && current[1] === last[1]) {
                        console.log("Removed duplicate point");
                    } else {
                        cleanRing.push(current);
                    }
                }

                // B. Ensure shape is big enough
                if (cleanRing.length < 3) {
                    alert("Shape too small. Please draw a triangle or square.");
                    draw.delete(feature.id);
                    return;
                }

                // C. Force Close Loop (A->B->C becomes A->B->C->A)
                const first = cleanRing[0];
                const lastPoint = cleanRing[cleanRing.length - 1];
                
                if (first[0] !== lastPoint[0] || first[1] !== lastPoint[1]) {
                    cleanRing.push(first);
                }

                // D. Update Feature
                feature.geometry.coordinates[0] = cleanRing;
                console.log(`Sending ${cleanRing.length} points to Radar (This is correct!)`);

                // 4. Send to API
                await saveToRadar(feature, name);
            });
        }

        async function saveToRadar(feature, name) {
            const risk = document.getElementById('zone-risk').value;
            const tag = 'safety-zone';
            const externalId = 'zone-' + Date.now();

            try {
                const res = await fetch(`https://api.radar.io/v1/geofences/${tag}/${externalId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': RADAR_SK,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description: name,
                        type: 'polygon',
                        coordinates: feature.geometry.coordinates,
                        metadata: { riskLevel: risk }
                    })
                });

                if (res.ok) {
                    addZoneToList(name, risk, tag, externalId, feature.id);
                    console.log("SUCCESS! Zone Saved.");
                } else {
                    const err = await res.json();
                    alert("Radar Error: " + err.meta.message);
                    draw.delete(feature.id);
                }
            } catch (e) {
                console.error(e);
                alert("Network Error");
                draw.delete(feature.id);
            }
        }

        function addZoneToList(name, risk, tag, id, drawId) {
            const li = document.createElement('li');
            li.className = 'zone-item';
            li.innerHTML = `
                <div><strong>${name}</strong><br><small>${risk}</small></div>
                <button onclick="deleteZone(this, '${tag}', '${id}', '${drawId}')" style="color:red; background:none; border:none; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
            `;
            zoneList.appendChild(li);
        }

        window.deleteZone = async function(btn, tag, id, drawId) {
            if(!confirm("Delete?")) return;
            await fetch(`https://api.radar.io/v1/geofences/${tag}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': RADAR_SK }
            });
            btn.closest('li').remove();
            if(drawId) draw.delete(drawId);
        }
    </script>
</body>
</html>
